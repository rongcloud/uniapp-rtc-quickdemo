import{installPlugin as e}from"@rongcloud/imlib-next";import*as t from"@/uni_modules/RCIM-Push";function s(e,t,s,i){return new(s||(s=Promise))((function(n,o){function r(e){try{a(i.next(e))}catch(e){o(e)}}function c(e){try{a(i.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(r,c)}a((i=i.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;let i=!1;var n,o;!function(e){e[e.SUCCESS=0]="SUCCESS",e[e.UNKNOWN=-1]="UNKNOWN"}(n||(n={})),function(e){e.IOS="iOS",e.UNKNOWN="unknown",e.HUAWEI="huawei",e.XIAOMI="xiaomi",e.MEIZU="meizu",e.VIVO="vivo",e.OPPO="oppo",e.HONOR="honor"}(o||(o={}));class r{constructor(e,s,i){this.lastUserToken="",this.context=e,this.options=s,this.pushRegisteredListener=i;let n="";n="ios"==uni.getSystemInfoSync().platform?t.getDeviceId(this.context.getAppkey()):t.getDeviceId();const o=t.getPackageName();this.context.setPushConfig({deviceId:n,packageName:o}),this.context.onconnectionstatechange=(e,t)=>{0===e&&this.registerNativePush()}}registerNativePush(){var e;return s(this,void 0,void 0,(function*(){try{let s=this.context.getAppkey(),i=this.context.getUserToken();if(i===this.lastUserToken)return void console.log("推送已注册，token 未变化，无需重新注册 NativePush");this.lastUserToken=i,(null===(e=this.options)||void 0===e?void 0:e.logLevel)&&t.setLogLevel(this.options.logLevel);const o=yield this.getPushServer();let r=yield this.getStatsServer();const c=t.registerPush(s,i,o,r);0!==c.code&&console.error("registerPush error = ",c.message),this.pushRegisteredListener&&this.pushRegisteredListener({code:0===c.code?n.SUCCESS:n.UNKNOWN,message:c.message})}catch(e){console.log(e),this.pushRegisteredListener&&this.pushRegisteredListener({code:n.UNKNOWN,message:e instanceof Error?e.message:"注册推送时发生未知错误"})}}))}getPushServer(){return s(this,void 0,void 0,(function*(){let e=this.context.getNaviInfo(),t="";return e&&(t=e.active&&e.active.addrs?e.active.addrs[0].addr:e.activeServer?e.activeServer:yield this.getStatsServer()),t}))}getStatsServer(){return s(this,void 0,void 0,(function*(){let e="";const t=yield this.context.getStatsUrlList();if(0===t.code&&t.data&&Array.isArray(t.data)&&t.data.length>0){const[s]=t.data;e=s}return e}))}}function c(t){return i?Promise.resolve({code:n.UNKNOWN,message:"推送已经注册过，不需要重复注册"}):new Promise((s=>{e({tag:"NativePushPlugin",verify:()=>!0,setup:(e,t,n)=>new r(e,n,(e=>{i=!0,s({code:e.code,message:e.message})}))},t)}))}function a(e){t.setOnNotificationClickedListener(e)}function u(){t.removeOnNotificationClickedListener()}function h(e){t.setOnPushTokenReceivedListener(e)}function d(){t.removeOnPushTokenReceivedListener()}function v(e){t.setOnPushTokenReportResultListener(e)}function g(){t.removeOnPushTokenReportResultListener()}export{n as PushErrorCode,o as PushType,c as registerPush,u as removeOnNotificationClickedListener,d as removeOnPushTokenReceivedListener,g as removeOnPushTokenReportResultListener,a as setOnNotificationClickedListener,h as setOnPushTokenReceivedListener,v as setOnPushTokenReportResultListener};
//# sourceMappingURL=index.js.map
