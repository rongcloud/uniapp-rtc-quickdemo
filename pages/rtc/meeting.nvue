<template>
	<view class="rtc-container">
		<!-- çŠ¶æ€æ å ä½ -->
		<view class="status-bar-placeholder"></view>

		<view class="header">
			<view class="title-row">
				<text class="nav-title">éŸ³è§†é¢‘ç›´æ’­</text>
			</view>
		</view>
		
		<!-- è¿”å›æŒ‰é’® - æ ¹æ®å¹³å°æ˜¾ç¤º -->
		<view class="back-button-container">
			<view class="nav-left-btn" @click="goBack" style="background-color: rgba(102, 126, 234, 0.8); padding: 15rpx 25rpx; border-radius: 15rpx; min-width: 120rpx; min-height: 70rpx;">
				<text class="back-text" style="color: white; font-size: 30rpx;">è¿”å›</text>
			</view>
		</view>

		<view class="status-bar">
			<text class="status-text">{{statusText}}</text>
		</view>

		<view class="video-container">
			<view class="video-card">
				<view class="video-card-header">
					<text class="video-icon">ğŸ“¹</text>
					<text class="card-title">è§†å›¾æ¸²æŸ“</text>
				</view>
				<view class="video-row">
					<!-- æœ¬åœ°è§†é¢‘ -->
					<view class="video-item">
						<view class="video-content">
							<view class="video-placeholder" v-if="!isLocalVideoReady">
								<text class="placeholder-text">æœ¬åœ°è§†å›¾</text>
							</view>
							<RCRTCView v-else ref="localView" class="video-player" :fitType="0" :mirror="false">
							</RCRTCView>
						</view>
					</view>

					<!-- è¿œç«¯è§†é¢‘ -->
					<view class="video-item">
						<view class="video-content">
							<view class="video-placeholder" v-if="!isRemoteVideoReady">
								<text class="placeholder-text">è¿œç«¯è§†å›¾</text>
							</view>
							<RCRTCView v-else ref="remoteView" class="video-player" :fitType="0" :mirror="false">
							</RCRTCView>
						</view>
					</view>
				</view>
			</view>
		</view>

		<view class="control-panel">
			<view class="room-info">
				<text class="room-label">æˆ¿é—´å·:</text>
				<input class="room-input" v-model="roomId" placeholder="è¯·è¾“å…¥æˆ¿é—´å·" maxlength="10" />
			</view>

			<!-- åŠ å…¥/ç¦»å¼€æˆ¿é—´ -->
			<view class="button-row">
				<view class="control-btn join-btn" :class="{ 'disabled': !roomId.trim() || isInRoom }"
					@click="handleJoinRoom">
					<text class="btn-text">{{ isJoining ? 'åŠ å…¥ä¸­...' : 'åŠ å…¥æˆ¿é—´' }}</text>
				</view>

				<view class="control-btn leave-btn" :class="{ 'disabled': !isInRoom }" @click="handleLeaveRoom">
					<text class="btn-text">ç¦»å¼€æˆ¿é—´</text>
				</view>
			</view>

			<!-- å‘å¸ƒèµ„æºæ§åˆ¶ -->
			<view class="button-row">
				<view class="control-btn rtc-btn" @click="publishStreams">
					<text class="btn-text">å‘å¸ƒèµ„æº</text>
				</view>

				<view class="control-btn rtc-btn" @click="unPublishStreams">
					<text class="btn-text">å–æ¶ˆå‘å¸ƒèµ„æº</text>
				</view>
			</view>

			<!-- è®¢é˜…èµ„æºæ§åˆ¶ -->
			<view class="button-row">
				<view class="control-btn rtc-btn" @click="subscribeStreams">
					<text class="btn-text">è®¢é˜…èµ„æº</text>
				</view>

				<view class="control-btn rtc-btn" @click="unSubscribeStreams">
					<text class="btn-text">å–æ¶ˆè®¢é˜…èµ„æº</text>
				</view>
			</view>

			<!-- æ‘„åƒå¤´æ§åˆ¶ -->
			<view class="button-row">
				<view class="control-btn rtc-btn" @click="enableCamera(true)">
					<text class="btn-text">æ‰“å¼€æ‘„åƒå¤´</text>
				</view>

				<view class="control-btn rtc-btn" @click="enableCamera(false)">
					<text class="btn-text">å…³é—­æ‘„åƒå¤´</text>
				</view>
			</view>

			<!-- éº¦å…‹é£æ§åˆ¶ -->
			<view class="button-row">
				<view class="control-btn rtc-btn" @click="enableMicrophone(true)">
					<text class="btn-text">æ‰“å¼€éº¦å…‹é£</text>
				</view>

				<view class="control-btn rtc-btn" @click="enableMicrophone(false)">
					<text class="btn-text">å…³é—­éº¦å…‹é£</text>
				</view>
			</view>

			<!-- æ‰¬å£°å™¨æ§åˆ¶ -->
			<view class="button-row">
				<view class="control-btn rtc-btn" @click="enableSpeaker(true)">
					<text class="btn-text">æ‰“å¼€æ‰¬å£°å™¨</text>
				</view>

				<view class="control-btn rtc-btn" @click="enableSpeaker(false)">
					<text class="btn-text">å…³é—­æ‰¬å£°å™¨</text>
				</view>
			</view>
		</view>
	</view>
</template>

<script>
	import globalState from '@/utils/IMEngineUtils.js'
	import RCRTCEngine from '@/uni_modules/RongCloud-RTCWrapper/lib/RCRTCEngine';
	import {
		RCRTCCamera,
		RCRTCMediaType,
		RCRTCRole,
		RCRTCViewFitType,
		RCRTCAudioSource,
	} from '@/uni_modules/RongCloud-RTCWrapper/lib/RCRTCDefines';

	export default {
		data() {
			return {
				currentUserId: '',
				roomId: '9991',
				isInRoom: false,
				isJoining: false,
				isLocalVideoReady: false,
				isRemoteVideoReady: false,
				isCameraOn: true,
				isMicrophoneOn: true,
				isSpeakerOn: true,
				statusText: 'å‡†å¤‡å°±ç»ª',
				rtcEngine: null,
				_isDestroyed: false,
				_isInitialized: false,
				_isCleaning: false, // æ·»åŠ æ¸…ç†æ ‡å¿—ï¼Œé˜²æ­¢é‡å¤æ¸…ç†
				roomJoinedListener: null,
				remoteUserId: '',
				isRemoteStreams: false,
				_isNavigating: false, // é˜²æ­¢é‡å¤å¯¼èˆª
			}
		},

		onLoad() {
			console.log('=== Meeting é¡µé¢ onLoad è§¦å‘ ===');
			this.initRTCEngine();
			const loginInfo = uni.getStorageSync('loginInfo')
			if (loginInfo) {
				this.currentUserId = loginInfo.userId;
				console.log(this.currentUserId);
			}
		},

		onShow() {
			console.log('onShow - é¡µé¢æ˜¾ç¤º (é‡æ–°è¿›å…¥é¡µé¢)');
			// é‡æ–°åˆå§‹åŒ–RTCå¼•æ“ï¼Œç¡®ä¿ç›‘å¬å™¨æ­£ç¡®è®¾ç½®
			this.initRTCEngine();
		},

		onHide() {
			console.log('onHide - é¡µé¢éšè— (iOSä¾§æ»‘è¿”å›ä¼šè§¦å‘)');
			// iOSä¾§æ»‘è¿”å›æ—¶ä¼šè§¦å‘onHideï¼Œéœ€è¦ç«‹å³æ¸…ç†
			this.forceCleanup();
		},

		onUnload() {
			console.log('onUnload - é¡µé¢å¸è½½ (iOSä¾§æ»‘è¿”å›ä¼šè§¦å‘)');
			this._isDestroyed = true;
			// ç¡®ä¿åœ¨é¡µé¢å¸è½½æ—¶ä¹Ÿè¿›è¡Œæ¸…ç†
			this.forceCleanup();
		},

		onBackPress() {
			console.log('onBackPress - æ‹¦æˆªè¿”å›æ“ä½œ (Androidè¿”å›é”®)');
			// æ‹¦æˆªç³»ç»Ÿè¿”å›ï¼Œä½¿ç”¨æˆ‘ä»¬çš„æ¸…ç†é€»è¾‘
			this.forceCleanup();
			// å»¶è¿Ÿå¯¼èˆªï¼Œç¡®ä¿æ¸…ç†å®Œæˆ
			setTimeout(() => {
				uni.navigateBack({
					delta: 1
				});
			}, 100);
			return false; // è¿”å› true é˜»æ­¢é»˜è®¤è¿”å›è¡Œä¸º
		},

		methods: {
			/**
			 * åˆå§‹åŒ–RTCå¼•æ“  å…·ä½“å‚è€ƒæ–‡æ¡£ï¼šhttps://docs.rongcloud.cn/uni-app-rtclib/engine-setup
			 */
			initRTCEngine() {
				try {
					console.log('=== å¼€å§‹åˆå§‹åŒ–RTCå¼•æ“ ===');

					// å…ˆæ¸…ç†æ—§çš„å¼•æ“
					if (this.rtcEngine) {
						console.log('æ¸…ç†æ—§çš„RTCå¼•æ“...');
						try {
							this.rtcEngine.destroy();
						} catch (e) {
							console.log('æ¸…ç†æ—§å¼•æ“æ—¶å‡ºé”™:', e);
						}
						this.rtcEngine = null;
					}

					// åˆ›å»ºæ–°çš„RTCå¼•æ“
					let audioSetup = {};
					let videoSetup = {
						enableTinyStream: false
					};
					let setup = {
						audioSetup: audioSetup,
						videoSetup: videoSetup,
					};

					this.rtcEngine = RCRTCEngine.create(setup);
					console.log('RTCå¼•æ“åˆ›å»ºç»“æœ:', !!this.rtcEngine);

					if (this.rtcEngine) {
						// è®¾ç½®æˆ¿é—´ç›‘å¬å™¨
						this.setRoomListener();

						// é‡ç½®çŠ¶æ€æ ‡å¿—
						this._isDestroyed = false;
						this._isInitialized = true;
						this.isInRoom = false;
						this.isJoining = false;
						this.isLocalVideoReady = false;
						this.isRemoteVideoReady = false;

						console.log('=== RTCå¼•æ“åˆå§‹åŒ–å®Œæˆ ===');
					} else {
						throw new Error('RTCå¼•æ“åˆ›å»ºå¤±è´¥ï¼Œè¿”å›null');
					}

				} catch (error) {
					console.error('RTCå¼•æ“åˆ›å»ºå¤±è´¥:', error);
					this.rtcEngine = null;
					this._isInitialized = false;
					uni.showToast({
						title: 'RTCå¼•æ“åˆå§‹åŒ–å¤±è´¥',
						icon: 'error'
					});
				}
			},

			/**
			 * æˆ¿é—´äº‹ä»¶ç›‘å¬    è¿™é‡Œåªå®ç°ä¸€éƒ¨åˆ†çŠ¶æ€ç›‘å¬å›è°ƒï¼Œå…·ä½“å¯ä»¥å‚è€ƒæ–‡æ¡£ï¼šhttps://docs.rongcloud.cn/uni-app-rtclib/quickstart-meeting
			 */
			setRoomListener() {
				/**
				 * æˆ¿é—´åŠ å…¥å›è°ƒ
				 */
				console.log('è®¾ç½® setOnRoomJoinedListener...');
				this.rtcEngine.setOnRoomJoinedListener(({
					code,
					message
				}) => {
					console.log('=== æˆ¿é—´åŠ å…¥å›è°ƒè§¦å‘ ===');
					console.log('å›è°ƒå‚æ•° - code:', code, 'message:', message);

					if (this._isDestroyed) {
						console.log('ç»„ä»¶å·²é”€æ¯ï¼Œå¿½ç•¥æˆ¿é—´åŠ å…¥å›è°ƒ');
						return;
					}

					if (code === 0) {
						console.log('æˆ¿é—´åŠ å…¥æˆåŠŸ:', message);
						this.isInRoom = true;
						this.statusText = 'å·²åŠ å…¥æˆ¿é—´';
						this.isJoining = false;

						// å¯ç”¨æ‘„åƒå¤´
						this.rtcEngine.enableCamera(true, RCRTCCamera.Front);
						this.isLocalVideoReady = true;

						// è®¾ç½®æœ¬åœ°è§†å›¾
						setTimeout(() => {
							if (this._isDestroyed) return;
							if (this.$refs.localView && this.$refs.localView.getNativeViewRef) {
								this.rtcEngine.setLocalView(this.$refs.localView.getNativeViewRef(), (
									code) => {
										console.log('è®¾ç½®æœ¬åœ°è§†å›¾ç»“æœ:', code);
										if (code === 0) {
											console.log('æœ¬åœ°è§†å›¾è®¾ç½®æˆåŠŸ');
										} else {
											console.error('æœ¬åœ°è§†å›¾è®¾ç½®å¤±è´¥:', code);
										}
									});
							}
						}, 100);

						uni.showToast({
							title: 'æˆ¿é—´åŠ å…¥æˆåŠŸ',
							icon: 'success'
						});
					} else {
						console.error('æˆ¿é—´åŠ å…¥å¤±è´¥:', code, message);
						this.statusText = 'æˆ¿é—´åŠ å…¥å¤±è´¥';
						this.isJoining = false;
						uni.showToast({
							title: 'æˆ¿é—´åŠ å…¥å¤±è´¥',
							icon: 'error'
						});
					}
				});

				/**
				 * è¿œç«¯ç”¨æˆ·åŠ å…¥æˆ¿é—´å›è°ƒ
				 */
				this.rtcEngine.setOnUserJoinedListener(({
					userId,
					roomId
				}) => {
					// userId è¿œç«¯ç”¨æˆ· ID
					// roomId æˆ¿é—´ ID
					console.log('è¿œç«¯ç”¨æˆ·åŠ å…¥:', userId, roomId)
					uni.showToast({
						title: `${userId}åŠ å…¥æˆ¿é—´`,
						icon: 'none'
					})
				});

				/**
				 * è¿œç«¯ç”¨æˆ·å‘å¸ƒèµ„æºå›è°ƒ
				 */
				this.rtcEngine.setOnRemotePublishedListener(({
					userId,
					roomId,
					type
				}) => {
					// userId è¿œç«¯ç”¨æˆ· ID
					// roomId æˆ¿é—´ ID
					// type è¿œç«¯ç”¨æˆ·å‘å¸ƒçš„èµ„æºç±»å‹ RCRTCMediaType
					console.log(userId)
					console.log(roomId)
					this.isRemoteStreams = true
					this.remoteUserId = userId
					uni.showToast({
						title: `${userId}å‘å¸ƒèµ„æº`,
						icon: 'none'
					})
				});

				/**
				 * è¿œç«¯ç”¨æˆ·ç¦»å¼€æˆ¿é—´å›è°ƒ
				 */
				this.rtcEngine.setOnUserLeftListener(({
					userId,
					roomId
				}) => {
					// userId è¿œç«¯ç”¨æˆ· ID
					// roomId æˆ¿é—´ ID
					this.isRemoteVideoReady = false
				});

				console.log('=== æˆ¿é—´ç›‘å¬å™¨è®¾ç½®å®Œæˆ ===');
			},

			/**
			 * è¿”å›ä¸Šä¸€é¡µ
			 */
			goBack() {
				console.log('goBack - è¿”å›ä¸Šä¸€é¡µ');
				this.forceCleanup();
				uni.navigateBack({
					delta: 1
				});
			},

			/**
			 * åŠ å…¥æˆ¿é—´    
			 * role èº«ä»½
			 * ä¼šè®®ç±»å‹èº«ä»½ï¼š
			 * RCRTCRole.MeetingMember    
			 * ç›´æ’­ç±»å‹èº«ä»½ï¼š
			 * RCRTCRole.LiveBroadcaster  ä¸»æ’­èº«ä»½
			 * RCRTCRole.LiveAudience  è§‚ä¼—èº«ä»½
			 *  
			 * 
			 * typeï¼šåª’ä½“ç±»å‹
			 * RCRTCMediaType.AudioVideo  éŸ³è§†é¢‘
			 * RCRTCMediaType.Audio  ä»…éŸ³é¢‘
			 * RCRTCMediaType.Video  ä»…è§†é¢‘
			 */
			async handleJoinRoom() {
				try {
					// æ£€æŸ¥ç»„ä»¶æ˜¯å¦å·²é”€æ¯
					if (this._isDestroyed) {
						console.log('ç»„ä»¶å·²é”€æ¯ï¼Œå–æ¶ˆåŠ å…¥æˆ¿é—´');
						return;
					}

					// æ£€æŸ¥RTCå¼•æ“æ˜¯å¦å¯ç”¨
					if (!this.rtcEngine) {
						console.error('RTCå¼•æ“ä¸å¯ç”¨ï¼Œæ— æ³•åŠ å…¥æˆ¿é—´');
						// uni.showToast({
						// 	title: 'RTCå¼•æ“ä¸å¯ç”¨',
						// 	icon: 'error'
						// });
						return;
					}

					this.isJoining = true;
					this.statusText = 'æ­£åœ¨åŠ å…¥æˆ¿é—´...';

					// å®šä¹‰åŠ å…¥æˆ¿é—´ç±»å‹
					let joinType = {
						type: RCRTCMediaType.AudioVideo,
						role: RCRTCRole.MeetingMember
					};

					// ç›´æ¥ä½¿ç”¨ RTC å¼•æ“åŠ å…¥æˆ¿é—´ï¼Œç›‘å¬å™¨å·²åœ¨ setRoomListener ä¸­è®¾ç½®
					console.log('è°ƒç”¨ rtcEngine.joinRoom - roomId:', this.roomId, 'joinType:', joinType);
					this.rtcEngine.joinRoom(this.roomId, joinType);
					console.log('joinRoom è°ƒç”¨å®Œæˆï¼Œç­‰å¾…å›è°ƒ...');

				} catch (error) {
					console.error('åŠ å…¥æˆ¿é—´å¼‚å¸¸:', error);
					if (!this._isDestroyed) {
						this.isJoining = false;
						this.statusText = 'åŠ å…¥æˆ¿é—´å¼‚å¸¸';
					}
				}
			},

			/**
			 * ç¦»å¼€æˆ¿é—´
			 */
			async handleLeaveRoom() {
				try {
					if (this.rtcEngine) {
						this.rtcEngine.leaveRoom();
						this.isInRoom = false;
						this.isLocalVideoReady = false;
						this.isRemoteVideoReady = false;
						this.statusText = 'å·²ç¦»å¼€æˆ¿é—´';

						uni.showToast({
							title: 'å·²ç¦»å¼€æˆ¿é—´',
							icon: 'success'
						})
					}
				} catch (error) {
					console.error('ç¦»å¼€æˆ¿é—´å¤±è´¥:', error);
					uni.showModal({
						title: 'æ“ä½œå¤±è´¥',
						content: 'ç¦»å¼€æˆ¿é—´æ—¶å‡ºç°å¼‚å¸¸ï¼Œè¯·é‡è¯•',
						showCancel: false,
						confirmText: 'ç¡®å®š',
						confirmColor: '#667eea'
					});
				}
			},

			/**
			 * å‘å¸ƒèµ„æº
			 */
			publishStreams() {
				if (this._isDestroyed || !this.rtcEngine) {
					console.log('ç»„ä»¶å·²é”€æ¯æˆ–RTCå¼•æ“æœªåˆå§‹åŒ–ï¼Œå–æ¶ˆå‘å¸ƒ');
					return;
				}

				console.log('å¼€å§‹å‘å¸ƒéŸ³è§†é¢‘èµ„æº...');
				this.statusText = 'æ­£åœ¨å‘å¸ƒèµ„æº...';

				try {
					this.rtcEngine.setOnPublishedListener(({
						type,
						code,
						message
					}) => {
						if (this._isDestroyed) {
							console.log('ç»„ä»¶å·²é”€æ¯ï¼Œå¿½ç•¥å‘å¸ƒå›è°ƒ');
							return;
						}

						if (code === 0) {
							this.statusText = 'éŸ³è§†é¢‘å‘å¸ƒæˆåŠŸ';
							console.log('éŸ³è§†é¢‘å‘å¸ƒæˆåŠŸ');
						} else {
							this.statusText = 'éŸ³è§†é¢‘å‘å¸ƒå¤±è´¥';
							console.error('å‘å¸ƒå¤±è´¥:', code, message);
						}
					});

					this.rtcEngine.publish(RCRTCMediaType.AudioVideo);

				} catch (error) {
					console.error('å‘å¸ƒèµ„æºå¼‚å¸¸:', error);
					this.statusText = 'å‘å¸ƒèµ„æºå¼‚å¸¸';
				}
			},

			/**
			 * å–æ¶ˆå‘å¸ƒèµ„æº
			 */
			unPublishStreams() {
				if (this._isDestroyed || !this.rtcEngine) {
					console.log('ç»„ä»¶å·²é”€æ¯æˆ–RTCå¼•æ“æœªåˆå§‹åŒ–ï¼Œå–æ¶ˆæ“ä½œ');
					return;
				}

				console.log('å¼€å§‹å–æ¶ˆå‘å¸ƒéŸ³è§†é¢‘èµ„æº...');
				this.statusText = 'æ­£åœ¨å–æ¶ˆå‘å¸ƒ...';

				try {
					this.rtcEngine.setOnUnpublishedListener(({
						type,
						code,
						message
					}) => {
						if (this._isDestroyed) {
							console.log('ç»„ä»¶å·²é”€æ¯ï¼Œå¿½ç•¥å–æ¶ˆå‘å¸ƒå›è°ƒ');
							return;
						}

						if (code === 0) {
							this.statusText = 'å–æ¶ˆéŸ³è§†é¢‘å‘å¸ƒæˆåŠŸ';
							console.log('å–æ¶ˆéŸ³è§†é¢‘å‘å¸ƒæˆåŠŸ');
						} else {
							this.statusText = 'å–æ¶ˆéŸ³è§†é¢‘å‘å¸ƒå¤±è´¥';
							console.error('å–æ¶ˆå‘å¸ƒå¤±è´¥:', code, message);
						}
					});

					this.rtcEngine.unpublish(RCRTCMediaType.AudioVideo);

				} catch (error) {
					console.error('å–æ¶ˆå‘å¸ƒèµ„æºå¼‚å¸¸:', error);
					this.statusText = 'å–æ¶ˆå‘å¸ƒèµ„æºå¼‚å¸¸';
				}
			},

			/**
			 * è®¢é˜…èµ„æº
			 */
			subscribeStreams() {
				if (this.remoteUserId) {
					console.log(this.remoteUserId)
					this.rtcEngine.subscribe(this.remoteUserId, RCRTCMediaType.AudioVideo);
					this.rtcEngine.setOnSubscribedListener(({
						userId,
						type,
						code,
						message
					}) => {
						// userId è¿œç«¯ç”¨æˆ· ID
						// type è®¢é˜…èµ„æºçš„ç±»å‹ RCRTCMediaType
						if (code === 0) {
							// è®¢é˜…æˆåŠŸ
							console.log('è®¢é˜…æˆåŠŸ')
							this.isRemoteVideoReady = true
							setTimeout(() => {
								this.rtcEngine.setRemoteView(this.remoteUserId, this.$refs.remoteView
									.getNativeViewRef(), (code) => {
										if (code === 0) {
											// è®¾ç½®æˆåŠŸ
											console.log('è®¾ç½®è¿œç«¯è§†å›¾æˆåŠŸ')
										} else {
											// è®¾ç½®å¤±è´¥
											console.log('è®¾ç½®è¿œç«¯è§†å›¾å¤±è´¥')
										}
									});
							}, 100)
						} else {
							// è®¢é˜…å¤±è´¥
							console.log('è®¢é˜…å¤±è´¥')
						}
					});
				} else {
					uni.showToast({
						title: 'è¯·å…ˆå‘å¸ƒèµ„æº',
						icon: 'error',
					})
				}
			},

			/**
			 * å–æ¶ˆè®¢é˜…èµ„æº
			 */
			unSubscribeStreams() {
				this.rtcEngine.unsubscribe(this.remoteUserId, RCRTCMediaType.AudioVideo);
				this.rtcEngine.setOnUnsubscribedListener(({
					userId,
					type,
					code,
					message
				}) => {
					// userId è¿œç«¯ç”¨æˆ· ID
					// type å–æ¶ˆè®¢é˜…èµ„æºçš„ç±»å‹ RCRTCMediaType
					if (code === 0) {
						// å–æ¶ˆè®¢é˜…æˆåŠŸ
						this.isRemoteVideoReady = false;
						uni.showToast({
							title: 'å–æ¶ˆè®¢é˜…æˆåŠŸ',
							icon: 'none'
						})
					} else {
						// å–æ¶ˆè®¢é˜…å¤±è´¥
						uni.showToast({
							title: 'å–æ¶ˆè®¢é˜…å¤±è´¥',
							icon: 'none'
						})
					}
				});
			},

			/**
			 * æ‰“å¼€/å…³é—­æ‘„åƒå¤´    æ‘„åƒå¤´å…¶ä»–è®¾ç½®å‚è€ƒæ–‡æ¡£ï¼šhttps://docs.rongcloud.cn/uni-app-rtclib/device/camera
			 */
			enableCamera(enable) {
				console.log(enable ? 'æ‰“å¼€æ‘„åƒå¤´' : 'å…³é—­æ‘„åƒå¤´');
				this.rtcEngine.enableCamera(enable);
				this.isCameraOn = enable;
				console.log('isSpeakerOn')
				uni.showToast({
					title: enable ? 'æ‰“å¼€æ‘„åƒå¤´' : 'å…³é—­æ‘„åƒå¤´',
					icon: 'none'
				});
			},

			/**
			 * æ‰“å¼€/å…³é—­éº¦å…‹é£    éº¦å…‹é£å…¶ä»–æ“ä½œï¼šhttps://docs.rongcloud.cn/uni-app-rtclib/device/microphone
			 */
			enableMicrophone(enable) {
				console.log(enable ? 'æ‰“å¼€éº¦å…‹é£' : 'å…³é—­éº¦å…‹é£');
				this.isMicrophoneOn = enable;
				this.rtcEngine.enableMicrophone(enable);
				uni.showToast({
					title: enable ? 'å·²æ‰“å¼€éº¦å…‹é£' : 'å·²å…³é—­éº¦å…‹é£',
					icon: 'none'
				});
			},

			/**
			 * æ‰“å¼€/å…³é—­æ‰¬å£°å™¨     å‚è€ƒæ–‡æ¡£ï¼šhttps://docs.rongcloud.cn/uni-app-rtclib/device/speaker
			 */
			enableSpeaker(enable) {
				console.log(enable ? 'æ‰“å¼€æ‰¬å£°å™¨' : 'å…³é—­æ‰¬å£°å™¨');
				this.isSpeakerOn = true;
				this.rtcEngine.enableSpeaker(enable);
				console.log('isSpeakerOn')
				uni.showToast({
					title: enable ? 'å·²æ‰“å¼€æ‰¬å£°å™¨' : 'å·²å…³é—­æ‰¬å£°å™¨',
					icon: 'none'
				});
			},

			/**
			 * å¼ºåˆ¶æ¸…ç†æ‰€æœ‰èµ„æº
			 */
			forceCleanup() {
				console.log('=== å¼ºåˆ¶æ¸…ç†æ‰€æœ‰èµ„æºå¼€å§‹ ===');
				console.log('å½“å‰é¡µé¢çŠ¶æ€ - isInRoom:', this.isInRoom, 'isJoining:', this.isJoining);

				// è®¾ç½®é”€æ¯æ ‡å¿—
				this._isDestroyed = true;

				// æ¸…ç†RTCå¼•æ“
				if (this.rtcEngine) {
					console.log('å¼€å§‹æ¸…ç†RTCå¼•æ“...');
					try {
						this.enableCamera(false);
						this.enableMicrophone(false);
						this.rtcEngine.leaveRoom();
						this.rtcEngine.destroy();
						console.log('RTCå¼•æ“æ¸…ç†å®Œæˆ');
					} catch (e) {
						console.log('æ¸…ç†RTCå¼•æ“å‡ºç°å¼‚å¸¸:', e);
					}
					this.rtcEngine = null;
				} else {
					console.log('RTCå¼•æ“ä¸å­˜åœ¨ï¼Œè·³è¿‡æ¸…ç†');
				}

				// é‡ç½®çŠ¶æ€
				this.isInRoom = false;
				this.isLocalVideoReady = false;
				this.isRemoteVideoReady = false;
				this.isJoining = false;
				this.isCameraOn = false;
				this.isMicrophoneOn = false;
				this.isSpeakerOn = false;
				this.statusText = 'å·²æ¸…ç†';
				this._isInitialized = false;
				this.remoteUserId = '';
				this.isRemoteStreams = false;
				console.log('=== å¼ºåˆ¶æ¸…ç†æ‰€æœ‰èµ„æºå®Œæˆ ===');
			},
		}
	}
</script>

<style scoped>
	.rtc-container {
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background-color: #f5f7fa;
		display: flex;
		flex-direction: column;
	}

	.status-bar-placeholder {
		height: 44px;
		background-color: #667eea;
	}

	.header {
		background-color: #667eea;
		box-shadow: 0 4rpx 12rpx rgba(102, 126, 234, 0.15);
	}

	.title-row {
	    display: flex;
	    align-items: center;
	    justify-content: center;
	    position: relative;
	    height: 100rpx;
	}

	.nav-left {
		display: flex;
		flex-direction: row;
		align-items: center;
		margin-right: 30rpx;
	}
	
	.nav-left-btn {
		background-color: transparent;
		border: none;
		padding: 0;
		margin: 0;
		display: flex;
		flex-direction: row;
		align-items: center;
		margin-right: 30rpx;
	}
	
	.back-button-container {
		position: absolute;
		top: 50%;
		left: 30rpx;
		transform: translateY(-10%);
		z-index: 1000;
	}
	
	.back-text {
		font-size: 28rpx;
		color: white;
	}

	.nav-title {
		position: absolute;
		left: 0;
		right: 0;
		font-size: 36rpx;
		font-weight: bold;
		color: white;
		text-align: center;
	}

	.room-info-text {
		font-size: 26rpx;
		color: rgba(255, 255, 255, 0.9);
		background-color: rgba(255, 255, 255, 0.1);
		padding: 8rpx 16rpx;
		border-radius: 20rpx;
	}

	.user-info-text {
		font-size: 26rpx;
		color: rgba(255, 255, 255, 0.9);
		background-color: rgba(255, 255, 255, 0.1);
		padding: 8rpx 16rpx;
		border-radius: 20rpx;
	}

	.video-container {
		padding: 32rpx;
		padding-bottom: 20rpx;
		display: flex;
		flex-direction: column;
	}

	.video-card {
		background-color: white;
		border-radius: 20rpx;
		padding: 20rpx;
		margin-bottom: 0;
		box-shadow: 0 4rpx 12rpx rgba(0, 0, 0, 0.08);
	}

	.video-card-header {
		display: flex;
		flex-direction: row;
		align-items: center;
		margin-bottom: 20rpx;
	}

	.card-title {
		font-size: 32rpx;
		color: #333;
		font-weight: bold;
		margin-left: 12rpx;
	}

	.video-row {
		display: flex;
		flex-direction: row;
	}

	.video-item {
		flex: 1;
		display: flex;
		flex-direction: column;
		margin: 0 10rpx;
	}

	.video-icon {
		font-size: 24rpx;
		margin-right: 12rpx;
	}

	.video-content {
		flex: 1;
	}

	.video-placeholder {
		height: 200rpx;
		background-color: #f8f9fa;
		border-radius: 12rpx;
		display: flex;
		align-items: center;
		justify-content: center;
		border: 1rpx solid #ddd;
	}

	.placeholder-text {
		color: #6c757d;
		font-size: 24rpx;
		text-align: center;
	}

	.video-player {
		flex: 1;
		height: 200rpx;
		border-radius: 12rpx;
		background-color: #000;
	}

	.control-panel {
		background-color: white;
		padding: 30rpx;
		margin: 20rpx 32rpx 32rpx 32rpx;
		border-radius: 25rpx;
		box-shadow: 0 8rpx 24rpx rgba(0, 0, 0, 0.1);
		border: 1rpx solid rgba(255, 255, 255, 0.8);
	}

	.room-info {
		flex-direction: row;
		align-items: center;
		margin-bottom: 30rpx;
		background-color: #f8f9fa;
		padding: 20rpx;
		border-radius: 15rpx;
		border: 1rpx solid #e9ecef;
	}

	.room-label {
		font-size: 28rpx;
		color: #495057;
		margin-right: 20rpx;
		width: 120rpx;
		font-weight: 500;
	}

	.room-input {
		flex: 1;
		height: 70rpx;
		border: 0;
		border-radius: 12rpx;
		padding: 0 20rpx;
		font-size: 28rpx;
		background-color: white;
		box-shadow: 0 2rpx 8rpx rgba(0, 0, 0, 0.05);
	}

	.button-row {
		display: flex;
		flex-direction: row;
		margin-bottom: 24rpx;
	}

	.control-btn {
		flex: 1;
		height: 88rpx;
		border-radius: 18rpx;
		border: 0;
		position: relative;
		overflow: hidden;
		margin: 0 8rpx;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.btn-text {
		font-size: 12dp;
		font-weight: bold;
		text-align: center;
		color: white;
	}

	.control-btn:first-child {
		margin-left: 0;
	}

	.control-btn:last-child {
		margin-right: 0;
	}

	.join-btn {
		background-color: #669eea;
		color: white;
		box-shadow: 0 4rpx 12rpx rgba(102, 126, 234, 0.3);
	}

	.join-btn.disabled {
		background-color: #ccc;
		box-shadow: none;
	}

	.join-btn.disabled .btn-text {
		color: #666;
	}

	.leave-btn {
		background-color: #ff6b6b;
		color: white;
		box-shadow: 0 4rpx 12rpx rgba(255, 107, 107, 0.3);
	}

	.leave-btn.disabled {
		background-color: #ccc;
		box-shadow: none;
	}

	.leave-btn.disabled .btn-text {
		color: #666;
	}

	.rtc-btn {
		background-color: #669eea;
		color: white;
		box-shadow: 0 4rpx 12rpx rgba(40, 167, 69, 0.3);
	}

	.debug-btn {
		background-color: #6c757d;
		color: white;
		box-shadow: 0 4rpx 12rpx rgba(108, 117, 125, 0.3);
	}

	.debug-btn:active {
		background-color: #003a6c;
		box-shadow: 0 4rpx 12rpx rgba(73, 80, 87, 0.4);
	}

	.status-bar {
		background-color: #343a40;
		padding: 24rpx 40rpx;
		margin: 20rpx 32rpx 0 32rpx;
		border-radius: 15rpx;
		box-shadow: 0 4rpx 12rpx rgba(0, 0, 0, 0.15);
		position: relative;
		overflow: hidden;
	}

	.status-text {
		color: white;
		font-size: 26rpx;
		text-align: center;
		font-weight: 500;
	}
</style>