<template>
	<view class="rtc-container">
		<!-- çŠ¶æ€æ å ä½ -->
		<view class="status-bar-placeholder"></view>

		<view class="header">
			<view class="title-row">
				<text class="nav-title">éŸ³è§†é¢‘ç›´æ’­</text>
			</view>
		</view>

		<!-- è¿”å›æŒ‰é’® - æ ¹æ®å¹³å°æ˜¾ç¤º -->
		<view class="back-button-container">
			<view class="nav-left-btn" @click="goBack" style="background-color: rgba(102, 126, 234, 0.8); padding: 15rpx 25rpx; border-radius: 15rpx; min-width: 120rpx; min-height: 70rpx;">
				<text class="back-text" style="color: white; font-size: 30rpx;">è¿”å›</text>
			</view>
		</view>

		<view class="status-bar">
			<text class="status-text">{{statusText}}</text>
		</view>

		<view class="video-container">
			<view class="video-card">
				<view class="video-card-header">
					<text class="video-icon">ğŸ“¹</text>
					<text class="card-title">è§†å›¾æ¸²æŸ“</text>
				</view>
				<view class="video-row">
					<!-- æœ¬åœ°è§†é¢‘ -->
					<view class="video-item">
						<view class="video-content">
							<view class="video-placeholder" v-if="!isLocalVideoReady">
								<text class="placeholder-text">æœ¬åœ°è§†å›¾</text>
							</view>
							<RCRTCView v-else ref="localView" class="video-player" :fitType="0" :mirror="false">
							</RCRTCView>
						</view>
					</view>

					<!-- è¿œç«¯è§†é¢‘ -->
					<view class="video-item">
						<view class="video-content">
							<view class="video-placeholder" v-if="!isRemoteVideoReady">
								<text class="placeholder-text">è¿œç«¯è§†å›¾</text>
							</view>
							<RCRTCView v-else ref="remoteView" class="video-player" :fitType="0" :mirror="false">
							</RCRTCView>
						</view>
					</view>

					<view class="video-item">
						<view class="video-content">
							<view class="video-placeholder" v-if="!isMixRemoteVideoReady">
								<text class="placeholder-text">åˆæµè§†å›¾</text>
							</view>
							<RCRTCView v-else ref="mixRemoteView" class="video-player" :fitType="0">
							</RCRTCView>
						</view>
					</view>
				</view>
			</view>
		</view>

		<view class="control-panel">
			<view class="room-info">
				<text class="room-label">æˆ¿é—´å·:</text>
				<input class="room-input" v-model="roomId" placeholder="è¯·è¾“å…¥æˆ¿é—´å·" maxlength="10" />
			</view>

			<!-- åŠ å…¥/ç¦»å¼€æˆ¿é—´ -->
			<view class="button-row">
				<view class="control-btn join-btn" :class="{ 'disabled': !roomId.trim() || isInRoom }"
					@click="handleJoinRoom(1)">
					<text class="btn-text">{{ isJoining ? 'åŠ å…¥ä¸­...' : 'ä¸»æ’­åŠ å…¥æˆ¿é—´' }}</text>
				</view>

				<view class="control-btn join-btn" :class="{ 'disabled': !roomId.trim() || isInRoom }"
					@click="handleJoinRoom(2)">
					<text class="btn-text">{{ isAudienceJoining ? 'åŠ å…¥ä¸­...' : 'è§‚ä¼—åŠ å…¥æˆ¿é—´' }}</text>
				</view>

				<view class="control-btn leave-btn" :class="{ 'disabled': !isInRoom }" @click="handleLeaveRoom">
					<text class="btn-text">ç¦»å¼€æˆ¿é—´</text>
				</view>
			</view>

			<!-- ä¸»æ’­å‘å¸ƒèµ„æº -->
			<view class="button-row">
				<view class="control-btn rtc-btn" @click="publishStreams">
					<text class="btn-text">ä¸»æ’­å‘å¸ƒèµ„æº</text>
				</view>

				<view class="control-btn rtc-btn" @click="unPublishStreams">
					<text class="btn-text">ä¸»æ’­å–æ¶ˆå‘å¸ƒèµ„æº</text>
				</view>
			</view>

			<!-- ä¸»æ’­è®¢é˜…èµ„æº -->
			<view class="button-row">
				<view class="control-btn rtc-btn" @click="subscribeStreams">
					<text class="btn-text">ä¸»æ’­è®¢é˜…èµ„æº</text>
				</view>

				<view class="control-btn rtc-btn" @click="unSubscribeStreams">
					<text class="btn-text">ä¸»æ’­å–æ¶ˆè®¢é˜…èµ„æº</text>
				</view>
			</view>

			<!-- è§‚ä¼—è®¢é˜…èµ„æº -->
			<view class="button-row">
				<view class="control-btn rtc-btn" @click="subscribeLiveMixStream">
					<text class="btn-text">è§‚ä¼—è®¢é˜…åˆæµ</text>
				</view>

				<view class="control-btn rtc-btn" @click="unSubscribeLiveMix">
					<text class="btn-text">è§‚ä¼—å–æ¶ˆè®¢é˜…åˆæµ</text>
				</view>
			</view>
			
			<!-- ä¸Šä¸‹éº¦ -->
			<view class="button-row">
				<view class="control-btn rtc-btn" @click="switchLiveRole(1)">
					<text class="btn-text">è§‚ä¼—ä¸Šéº¦</text>
				</view>
			
				<view class="control-btn rtc-btn" @click="switchLiveRole(2)">
					<text class="btn-text">ä¸»æ’­ä¸‹éº¦</text>
				</view>
			</view>

			<!-- æ··éŸ³ -->
			<view class="button-row">
				<view class="control-btn rtc-btn" @click="startAudioMixing">
					<text class="btn-text">æ’­æ”¾æ··éŸ³</text>
				</view>

				<view class="control-btn rtc-btn" @click="stopAudioMixing">
					<text class="btn-text">åœæ­¢æ’­æ”¾æ··éŸ³</text>
				</view>
			</view>
		</view>
	</view>
</template>

<script>
	import globalState from '@/utils/IMEngineUtils.js'
	import RCRTCEngine from '@/uni_modules/RongCloud-RTCWrapper/lib/RCRTCEngine';
	import {
		RCRTCVideoFps,
		RCRTCCamera,
		RCRTCMediaType,
		RCRTCRole,
		RCRTCViewFitType,
		RCRTCAudioSource,
		RCRTCLiveMixLayoutMode,
		RCRTCAudioMixingMode,
	} from '@/uni_modules/RongCloud-RTCWrapper/lib/RCRTCDefines';

	export default {
		data() {
			return {
				currentUserId: '',
				roomId: '9991',
				isInRoom: false,
				isJoining: false,
				isAudienceJoining: false,
				isLocalVideoReady: false,
				isRemoteVideoReady: false,
				isMixRemoteVideoReady: false,
				isCameraOn: true,
				isMicrophoneOn: true,
				isSpeakerOn: true,
				statusText: 'å‡†å¤‡å°±ç»ª',
				rtcEngine: null,
				_isDestroyed: false,
				_isInitialized: false,
				_isCleaning: false, // æ·»åŠ æ¸…ç†æ ‡å¿—ï¼Œé˜²æ­¢é‡å¤æ¸…ç†
				roomJoinedListener: null,
				remoteUserId: '',
				isRemoteStreams: false,
				isMixStreams: false,
				userRole: null,
				showBackButton: false // æ˜¯å¦æ˜¾ç¤ºè¿”å›æŒ‰é’®
			}
		},

		onLoad() {
			console.log('=== Live é¡µé¢ onLoad è§¦å‘ ===');
			
			// åˆ¤æ–­å¹³å°ï¼ŒAndroid æ˜¾ç¤ºè¿”å›æŒ‰é’®ï¼ŒiOS ä¸æ˜¾ç¤º
			// #ifdef APP-PLUS
			const platform = uni.getSystemInfoSync().platform;
			this.showBackButton = platform === 'android';
			console.log('å½“å‰å¹³å°:', platform, 'æ˜¾ç¤ºè¿”å›æŒ‰é’®:', this.showBackButton);
			// #endif
			
			// #ifndef APP-PLUS
			// é APP ç¯å¢ƒé»˜è®¤æ˜¾ç¤ºè¿”å›æŒ‰é’®
			this.showBackButton = true;
			// #endif
			
			this.initRTCEngine();
			const loginInfo = uni.getStorageSync('loginInfo')
			if (loginInfo) {
				this.currentUserId = loginInfo.userId;
				console.log(this.currentUserId);
			}
		},
		
		onShow() {
			console.log('onShow - é¡µé¢æ˜¾ç¤º (é‡æ–°è¿›å…¥é¡µé¢)');
			// é‡æ–°åˆå§‹åŒ–RTCå¼•æ“ï¼Œç¡®ä¿ç›‘å¬å™¨æ­£ç¡®è®¾ç½®
			this.initRTCEngine();
		},
		
		onHide() {
			console.log('onHide - é¡µé¢éšè— (iOSä¾§æ»‘è¿”å›ä¼šè§¦å‘)');
			// iOSä¾§æ»‘è¿”å›æ—¶ä¼šè§¦å‘onHideï¼Œéœ€è¦ç«‹å³æ¸…ç†
			this.forceCleanup();
		},

		onBackPress() {
			console.log('onBackPress - æ‹¦æˆªè¿”å›æ“ä½œ');
			// æ‹¦æˆªç³»ç»Ÿè¿”å›ï¼Œä½¿ç”¨æˆ‘ä»¬çš„æ¸…ç†é€»è¾‘
			this._isDestroyed = true;
			this.forceCleanup()
			return false;
		},

		methods: {
			/**
			 * åˆå§‹åŒ–RTCå¼•æ“    å…·ä½“å‚è€ƒæ–‡æ¡£ï¼šhttps://docs.rongcloud.cn/uni-app-rtclib/engine-setup
			 */
			initRTCEngine() {
				try {
					console.log('=== å¼€å§‹åˆå§‹åŒ–RTCå¼•æ“ ===');
					
					// å…ˆæ¸…ç†æ—§çš„å¼•æ“
					if (this.rtcEngine) {
						console.log('æ¸…ç†æ—§çš„RTCå¼•æ“...');
						try {
							this.rtcEngine.destroy();
						} catch (e) {
							console.log('æ¸…ç†æ—§å¼•æ“æ—¶å‡ºé”™:', e);
						}
						this.rtcEngine = null;
					}
					
					let audioSetup = {};
					let videoSetup = {
						enableTinyStream: false
					};
					let setup = {
						audioSetup: audioSetup,
						videoSetup: videoSetup,
					};
					this.rtcEngine = RCRTCEngine.create(setup);
					console.log('RTCå¼•æ“åˆ›å»ºç»“æœ:', !!this.rtcEngine);

					if (this.rtcEngine) {
						this.setRoomListener(); // ä¸»æ’­æˆ¿é—´äº‹ä»¶ç›‘å¬ 
						this.setdLiveAudienceRoomListener() // è§‚ä¼—æˆ¿é—´çŠ¶æ€ç›‘å¬
						this.setAudioMix()  //  æ··éŸ³ç›¸å…³å›è°ƒ
						// é‡ç½®é”€æ¯æ ‡å¿—å’Œè®¾ç½®åˆå§‹åŒ–æ ‡å¿—
						this._isDestroyed = false;
						this._isInitialized = true;
						console.log('=== RTCå¼•æ“åˆå§‹åŒ–å®Œæˆ ===');
					} else {
						throw new Error('RTCå¼•æ“åˆ›å»ºå¤±è´¥ï¼Œè¿”å›null');
					}

				} catch (error) {
					console.error('RTCå¼•æ“åˆ›å»ºå¤±è´¥:', error);
					console.error('é”™è¯¯è¯¦æƒ…:', error.message, error.stack);
					this.rtcEngine = null;
					this._isInitialized = false;
					this._isDestroyed = true;
					uni.showToast({
						title: 'RTCå¼•æ“åˆå§‹åŒ–å¤±è´¥',
						icon: 'error'
					});
				}
			},

			/**
			 * æˆ¿é—´äº‹ä»¶ç›‘å¬
			 */
			setRoomListener() {

				/**
				 * è¿œç«¯ç”¨æˆ·åŠ å…¥æˆ¿é—´å›è°ƒ
				 */
				this.rtcEngine.setOnUserJoinedListener(({
					userId,
					roomId
				}) => {
					// userId è¿œç«¯ç”¨æˆ· ID
					// roomId æˆ¿é—´ ID
					console.log(userId)
					console.log(roomId)
					this.remoteUserId = userId

					uni.showToast({
						title: `${userId}åŠ å…¥æˆ¿é—´`,
						icon: 'none'
					})
				});

				/**
				 * è¿œç«¯ç”¨æˆ·å‘å¸ƒèµ„æºå›è°ƒ
				 */
				this.rtcEngine.setOnRemotePublishedListener(({
					userId,
					roomId,
					type
				}) => {
					// userId è¿œç«¯ç”¨æˆ· ID
					// roomId æˆ¿é—´ ID
					// type è¿œç«¯ç”¨æˆ·å‘å¸ƒçš„èµ„æºç±»å‹ RCRTCMediaType
					console.log(userId)
					console.log(roomId)
					this.isRemoteStreams = true
					uni.showToast({
						title: `${userId}å‘å¸ƒèµ„æº`,
						icon: 'none'
					})
				});
				// è¿œç«¯ç”¨æˆ·åˆ‡æ¢è§’è‰²çš„å›è°ƒ
				this.rtcEngine.setOnRemoteLiveRoleSwitchedListener(({
					roomId,
					userId,
					role
				}) => {
					this.remoteUserId = userId;
					uni.showToast({
						title: `${userId}åˆ‡æ¢èº«ä»½ä¸º${role}`
					})
				});
				
				/**
				 * è¿œç«¯ç”¨æˆ·ç¦»å¼€æˆ¿é—´å›è°ƒ
				 */
				this.rtcEngine.setOnUserLeftListener(({
					userId,
					roomId
				}) => {
					// userId è¿œç«¯ç”¨æˆ· ID
					// roomId æˆ¿é—´ ID
					this.isRemoteVideoReady = false
				});
			},


			/**
			 * è§‚ä¼— æˆ¿é—´çŠ¶æ€äº‹ä»¶è®¾ç½®
			 */

			setdLiveAudienceRoomListener() {
				/**
				 * åˆæµèµ„æºå‘å¸ƒç›‘å¬
				 */
				this.rtcEngine.setOnRemoteLiveMixPublishedListener(({
					type
				}) => {
					// type èµ„æºç±»å‹ RCRTCMediaType
					this.isMixStreams = true
					uni.showToast({
						title: 'ä¸»æ’­å‘å¸ƒåˆæµ',
						icon: 'none'
					})
				});
				/**
				 * åˆæµèµ„æºå–æ¶ˆå‘å¸ƒç›‘å¬
				 */
				this.rtcEngine.setOnRemoteLiveMixUnpublishedListener(({
					type
				}) => {
					// type èµ„æºç±»å‹ RCRTCMediaType
					this.isMixStreams = false
					uni.showToast({
						title: 'ä¸»æ’­å‘å¸ƒåˆæµ',
						icon: 'none'
					})
				});
			},
			
			
			/**
			 * æ··éŸ³ç›¸å…³å›è°ƒ
			 */
			
			setAudioMix(){
				// è®¾ç½®å¼€å§‹æ··éŸ³ç›‘å¬
				this.rtcEngine.setOnAudioMixingStartedListener(() => {
				    // å¼€å§‹æ··éŸ³
					console.log('setOnAudioMixingStartedListener')
				});
				
				// è®¾ç½®æš‚åœæ··éŸ³ç›‘å¬
				this.rtcEngine.setOnAudioMixingPausedListener(() => {
				    // æš‚åœæ··éŸ³
					console.log('setOnAudioMixingPausedListener')
				});
				
				/// è®¾ç½®åœæ­¢æ··éŸ³ç›‘å¬
				this.rtcEngine.setOnAudioMixingStoppedListener(() => {
				    // åœæ­¢æ··éŸ³
					console.log('setOnAudioMixingStoppedListener')
				});
				
				/// è®¾ç½®æ··éŸ³æ–‡ä»¶å·²è‡ªåŠ¨æ··æµå®Œæˆç›‘å¬
				this.rtcEngine.setOnAudioMixingFinishedListener(() => {
				    // æ··éŸ³æ–‡ä»¶å·²è‡ªåŠ¨æ··æµå®Œæˆ
					console.log('setOnAudioMixingFinishedListener')
				});
			},

			/**
			 * è¿”å›ä¸Šä¸€é¡µ
			 */
			goBack() {
				console.log('goBack - è¿”å›ä¸Šä¸€é¡µ');
				this.forceCleanup();
				uni.navigateBack({
					delta: 1
				});
			},

			/**
			 * åŠ å…¥æˆ¿é—´    
			 * role èº«ä»½
			 * ä¼šè®®ç±»å‹èº«ä»½ï¼š
			 * RCRTCRole.MeetingMember     0 
			 * ç›´æ’­ç±»å‹èº«ä»½ï¼š
			 * RCRTCRole.LiveBroadcaster  ä¸»æ’­èº«ä»½ 1 
			 * RCRTCRole.LiveAudience  è§‚ä¼—èº«ä»½  2 
			 *  
			 * 
			 * typeï¼šåª’ä½“ç±»å‹
			 * RCRTCMediaType.AudioVideo  éŸ³è§†é¢‘
			 * RCRTCMediaType.Audio  ä»…éŸ³é¢‘ 0
			 * RCRTCMediaType.Video  ä»…è§†é¢‘ 1
			 */

			async handleJoinRoom(role) {
				try {
					console.log('=== å¼€å§‹åŠ å…¥æˆ¿é—´ ===');
					this.userRole = role;
					// æ£€æŸ¥ç»„ä»¶æ˜¯å¦å·²é”€æ¯
					if (this._isDestroyed) {
						console.log('ç»„ä»¶å·²é”€æ¯ï¼Œå–æ¶ˆåŠ å…¥æˆ¿é—´');
						return;
					}
					if (role === 1) {
						this.isJoining = true;
					} else if (role === 2) {
						this.isAudienceJoining = true;
					}
					this.statusText = 'æ­£åœ¨åŠ å…¥æˆ¿é—´...';
					let joinType = {
						type: RCRTCMediaType.AudioVideo,
						role: role
					};

					// å…ˆç§»é™¤ä¹‹å‰çš„ç›‘å¬å™¨
					if (this.roomJoinedListener) {
						this.rtcEngine.setOnRoomJoinedListener(null);
						this.roomJoinedListener = null;
					}

					// åˆ›å»ºæ–°çš„ç›‘å¬å™¨
					this.roomJoinedListener = ({
						code,
						message
					}) => {
						if (this._isDestroyed) {
							console.log('ç»„ä»¶å·²é”€æ¯ï¼Œå¿½ç•¥å›è°ƒ');
							return;
						}

						if (code === 0) {
							this.isInRoom = true;
							this.statusText = 'å·²åŠ å…¥æˆ¿é—´';
							if (this.userRole === 1) {
								this.rtcEngine.enableCamera(true, RCRTCCamera.Front);
								this.isLocalVideoReady = true;
								setTimeout(() => {
									if (this._isDestroyed) return;

									if (this.$refs.localView && this.$refs.localView.getNativeViewRef) {
										this.rtcEngine.setLocalView(this.$refs.localView
											.getNativeViewRef(), (code) => {
												console.log('è®¾ç½®æœ¬åœ°è§†å›¾ç»“æœ:', code);
												if (code === 0) {
													console.log('æœ¬åœ°è§†å›¾è®¾ç½®æˆåŠŸ');
												} else {
													console.error('æœ¬åœ°è§†å›¾è®¾ç½®å¤±è´¥:', code);
												}
											});
									} else {
										console.error('localView å¼•ç”¨ä¸å­˜åœ¨æˆ–æ–¹æ³•ä¸å¯ç”¨');
									}
								}, 100);
							}
						} else {
							this.statusText = 'åŠ å…¥æˆ¿é—´å¤±è´¥';
							console.error('åŠ å…¥æˆ¿é—´å¤±è´¥:', code, message);
							uni.showToast({
								title: 'åŠ å…¥æˆ¿é—´å¤±è´¥',
								icon: 'none'
							});
						}

						if (!this._isDestroyed) {
							this.isJoining = false;
							this.isAudienceJoining = false;
						}
					};

					// è®¾ç½®ç›‘å¬å™¨
					this.rtcEngine.setOnRoomJoinedListener(this.roomJoinedListener);

					// åŠ å…¥æˆ¿é—´
					this.rtcEngine.joinRoom(this.roomId, joinType);

				} catch (error) {
					console.error('åŠ å…¥æˆ¿é—´å¼‚å¸¸:', error);
					if (!this._isDestroyed) {
						this.isJoining = false;
						this.statusText = 'åŠ å…¥æˆ¿é—´å¼‚å¸¸';
					}
				}
			},

			/**
			 * ç¦»å¼€æˆ¿é—´
			 */
			async handleLeaveRoom() {
				try {
					if (this.rtcEngine) {
						this.rtcEngine.leaveRoom();
						this.isInRoom = false;
						this.isLocalVideoReady = false;
						this.isRemoteVideoReady = false;
						this.isMixRemoteVideoReady = false;
						this.statusText = 'å·²ç¦»å¼€æˆ¿é—´';

						uni.showToast({
							title: 'å·²ç¦»å¼€æˆ¿é—´',
							icon: 'success'
						})
					}
				} catch (error) {
					console.error('ç¦»å¼€æˆ¿é—´å¤±è´¥:', error);
					uni.showModal({
						title: 'æ“ä½œå¤±è´¥',
						content: 'ç¦»å¼€æˆ¿é—´æ—¶å‡ºç°å¼‚å¸¸ï¼Œè¯·é‡è¯•',
						showCancel: false,
						confirmText: 'ç¡®å®š',
						confirmColor: '#667eea'
					});
				}
			},

			/**
			 * å‘å¸ƒèµ„æº
			 */
			publishStreams() {
				if (this._isDestroyed || !this.rtcEngine) {
					console.log('ç»„ä»¶å·²é”€æ¯æˆ–RTCå¼•æ“æœªåˆå§‹åŒ–ï¼Œå–æ¶ˆå‘å¸ƒ');
					return;
				}

				console.log('å¼€å§‹å‘å¸ƒéŸ³è§†é¢‘èµ„æº...');
				this.statusText = 'æ­£åœ¨å‘å¸ƒèµ„æº...';

				try {
					this.rtcEngine.setOnPublishedListener(({
						type,
						code,
						message
					}) => {
						if (this._isDestroyed) {
							console.log('ç»„ä»¶å·²é”€æ¯ï¼Œå¿½ç•¥å‘å¸ƒå›è°ƒ');
							return;
						}

						if (code === 0) {
							// è®¾ç½®åˆæµå¤§æµç”»å¸ƒç ç‡/åˆ†è¾¨ç‡/å¸§ç‡
							this.rtcEngine.setLiveMixVideoBitrate(2200);
							this.rtcEngine.setLiveMixVideoResolution(720, 1280);
							this.rtcEngine.setLiveMixVideoFps(RCRTCVideoFps.Fps15);
							this.rtcEngine.setLiveMixLayoutMode(RCRTCLiveMixLayoutMode.Adaptive);
							this.statusText = 'éŸ³è§†é¢‘å‘å¸ƒæˆåŠŸ';
							console.log('éŸ³è§†é¢‘å‘å¸ƒæˆåŠŸ');
						} else {
							this.statusText = 'éŸ³è§†é¢‘å‘å¸ƒå¤±è´¥';
							console.error('å‘å¸ƒå¤±è´¥:', code, message);
						}
					});

					this.rtcEngine.publish(RCRTCMediaType.AudioVideo);

				} catch (error) {
					console.error('å‘å¸ƒèµ„æºå¼‚å¸¸:', error);
					this.statusText = 'å‘å¸ƒèµ„æºå¼‚å¸¸';
				}
			},

			/**
			 * å–æ¶ˆå‘å¸ƒèµ„æº
			 */
			unPublishStreams() {
				if (this._isDestroyed || !this.rtcEngine) {
					console.log('ç»„ä»¶å·²é”€æ¯æˆ–RTCå¼•æ“æœªåˆå§‹åŒ–ï¼Œå–æ¶ˆæ“ä½œ');
					return;
				}

				console.log('å¼€å§‹å–æ¶ˆå‘å¸ƒéŸ³è§†é¢‘èµ„æº...');
				this.statusText = 'æ­£åœ¨å–æ¶ˆå‘å¸ƒ...';

				try {
					this.rtcEngine.setOnUnpublishedListener(({
						type,
						code,
						message
					}) => {
						if (this._isDestroyed) {
							console.log('ç»„ä»¶å·²é”€æ¯ï¼Œå¿½ç•¥å–æ¶ˆå‘å¸ƒå›è°ƒ');
							return;
						}

						if (code === 0) {
							this.statusText = 'å–æ¶ˆéŸ³è§†é¢‘å‘å¸ƒæˆåŠŸ';
							console.log('å–æ¶ˆéŸ³è§†é¢‘å‘å¸ƒæˆåŠŸ');
						} else {
							this.statusText = 'å–æ¶ˆéŸ³è§†é¢‘å‘å¸ƒå¤±è´¥';
							console.error('å–æ¶ˆå‘å¸ƒå¤±è´¥:', code, message);
						}
					});

					this.rtcEngine.unpublish(RCRTCMediaType.AudioVideo);

				} catch (error) {
					console.error('å–æ¶ˆå‘å¸ƒèµ„æºå¼‚å¸¸:', error);
					this.statusText = 'å–æ¶ˆå‘å¸ƒèµ„æºå¼‚å¸¸';
				}
			},

			/**
			 * ä¸»æ’­è®¢é˜…èµ„æº
			 */
			subscribeStreams() {
				if (this.remoteUserId && this.userRole ===1) {
					console.log(this.remoteUserId)
					this.rtcEngine.subscribe(this.remoteUserId, RCRTCMediaType.AudioVideo);
					this.rtcEngine.setOnSubscribedListener(({
						userId,
						type,
						code,
						message
					}) => {
						// userId è¿œç«¯ç”¨æˆ· ID
						// type è®¢é˜…èµ„æºçš„ç±»å‹ RCRTCMediaType
						if (code === 0) {
							this.enableSpeaker(true)  // è¿™é‡Œä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºï¼Œé»˜è®¤æ‰“å¼€æ‰¬å£°å™¨ï¼Œå®é™…æŒ‰ç…§éœ€æ±‚è®¾ç½®
							// è®¢é˜…æˆåŠŸ
							console.log('è®¢é˜…æˆåŠŸ')
							this.isRemoteVideoReady = true
							setTimeout(() => {
								if (this.$refs.remoteView && this.$refs.remoteView.getNativeViewRef) {
									this.rtcEngine.setRemoteView(this.remoteUserId, this.$refs.remoteView
										.getNativeViewRef(), (code) => {
											if (code === 0) {
												// è®¾ç½®æˆåŠŸ
												console.log('è®¾ç½®è¿œç«¯è§†å›¾æˆåŠŸ')
											} else {
												// è®¾ç½®å¤±è´¥
												console.log('è®¾ç½®è¿œç«¯è§†å›¾å¤±è´¥')
											}
										});
								} else {
									console.error('remoteView å¼•ç”¨ä¸å­˜åœ¨æˆ–æ–¹æ³•ä¸å¯ç”¨');
								}
							}, 100)
						} else {
							// è®¢é˜…å¤±è´¥
							console.log('è®¢é˜…å¤±è´¥')
						}
					});
				} else {
					//  æ³¨æ„ï¼šè¿™é‡Œæ¼”ç¤ºåªæ˜¯æ§åˆ¶äº†ï¼Œåªæœ‰ä¸»æ’­å¯ä»¥è®¢é˜…åˆ†æµï¼Œå®é™…ä¸Šéƒ½å¯ä»¥ï¼ŒæŒ‰ç…§ä¸šåŠ¡é€»è¾‘å¤„ç†å°±è¡Œï¼Œä¸€èˆ¬ç›´æ’­åœºæ™¯æ˜¯ è§‚ä¼—è®¢é˜…åˆæµ
					uni.showToast({
						title: 'æ²¡äººå‘å¸ƒèµ„æºæˆ–è€…èº«ä»½ä¸å¯¹',     
						icon: 'error',
					})
				}
			},


			/**
			 * è§‚ä¼—è®¢é˜…åˆæµèµ„æº
			 */

			subscribeLiveMixStream() {
				console.log(this.isMixStreams)
				if (this.isMixStreams) {
					this.rtcEngine.subscribeLiveMix(RCRTCMediaType.AudioVideo);

					this.rtcEngine.setOnLiveMixSubscribedListener((result) => {
						console.log(result)
						if (result.code === 0) {
							this.enableSpeaker(true)  // è¿™é‡Œä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºï¼Œé»˜è®¤æ‰“å¼€æ‰¬å£°å™¨ï¼Œå®é™…æŒ‰ç…§éœ€æ±‚è®¾ç½®
							/// åˆ›å»ºé¢„è§ˆçª—å£
							this.isMixRemoteVideoReady = true
							setTimeout(() => {
								if (this.$refs.mixRemoteView && this.$refs.mixRemoteView.getNativeViewRef) {
									this.rtcEngine.setLiveMixView(this.$refs.mixRemoteView.getNativeViewRef(),
										(code) => {
											if (code === 0) {
												// è®¾ç½®æˆåŠŸ
												console.log('è®¾ç½®åˆæµviewæˆåŠŸ')
											} else {
												// è®¾ç½®å¤±è´¥
												console.log('è®¾ç½®åˆæµviewå¤±è´¥' + code)
											}
										});
								} else {
									console.error('mixRemoteView å¼•ç”¨ä¸å­˜åœ¨æˆ–æ–¹æ³•ä¸å¯ç”¨');
								}
							}, 100)
						} else {
							uni.showToast({
								title: 'è®¢é˜…åˆæµå¤±è´¥',
								icon: 'none'
							})
						}

					})
				}
			},

			/**
			 * ä¸»æ’­å–æ¶ˆè®¢é˜…èµ„æº
			 */
			unSubscribeStreams() {
				this.rtcEngine.unsubscribe(this.remoteUserId, RCRTCMediaType.AudioVideo);
				this.rtcEngine.setOnUnsubscribedListener(({
					userId,
					type,
					code,
					message
				}) => {
					// userId è¿œç«¯ç”¨æˆ· ID
					// type å–æ¶ˆè®¢é˜…èµ„æºçš„ç±»å‹ RCRTCMediaType
					if (code === 0) {
						// å–æ¶ˆè®¢é˜…æˆåŠŸ
						this.isRemoteVideoReady = false;
						uni.showToast({
							title: 'å–æ¶ˆè®¢é˜…æˆåŠŸ',
							icon: 'none'
						})
					} else {
						// å–æ¶ˆè®¢é˜…å¤±è´¥
						uni.showToast({
							title: 'å–æ¶ˆè®¢é˜…å¤±è´¥',
							icon: 'none'
						})
					}
				});
			},

			/**
			 * è§‚ä¼—å–æ¶ˆè®¢é˜…èµ„æº
			 */
			unSubscribeLiveMix() {
				this.rtcEngine.unsubscribeLiveMix(RCRTCMediaType.AudioVideo);
				this.rtcEngine.setOnLiveMixUnsubscribedListener(({
					userId,
					type,
					code,
					message
				}) => {
					// userId è¿œç«¯ç”¨æˆ· ID
					// type å–æ¶ˆè®¢é˜…èµ„æºçš„ç±»å‹ RCRTCMediaType
					if (code === 0) {
						// å–æ¶ˆè®¢é˜…æˆåŠŸ
						this.isMixRemoteVideoReady = false;
						uni.showToast({
							title: 'å–æ¶ˆåˆæµè®¢é˜…æˆåŠŸ',
							icon: 'none'
						})
					} else {
						// å–æ¶ˆè®¢é˜…å¤±è´¥
						uni.showToast({
							title: 'å–æ¶ˆåˆæµè®¢é˜…å¤±è´¥',
							icon: 'none'
						})
					}
				});
			},


			/**
			 * ä¸Šä¸‹éº¦   å‚è€ƒæ–‡æ¡£ï¼šhttps://docs.rongcloud.cn/uni-app-rtclib/cohost/oneroom
			 */

			switchLiveRole(userRole) {
				console.log(userRole)
				// åˆ‡æ¢è§’è‰²çš„å›è°ƒ   æ³¨æ„ï¼šè¿™é‡Œçš„å‚æ•°æ˜¯æŒ‡æ‚¨è¦åˆ‡æ¢çš„ç›®æ ‡è§’è‰²ï¼Œè§‚ä¼—åªèƒ½ä¸Šéº¦ï¼Œä¸»æ’­åªèƒ½ä¸‹éº¦ã€‚
				this.rtcEngine.setOnLiveRoleSwitchedListener(({
					role,
					code,
					errMsg
				}) => {
					if (code == 0) {
						// åˆ‡æ¢æˆåŠŸ
						console.log(userRole)
						if (userRole === 2) {
							this.isRemoteVideoReady = false;
							this.isLocalVideoReady = false;		
						} else if (userRole === 1) {
							console.log(role);
							this.rtcEngine.enableCamera(true, RCRTCCamera.Front);
							this.isLocalVideoReady = true;
							this.isMixRemoteVideoReady = false;
							this.publishStreams()
							setTimeout(() => {
								if (this._isDestroyed) return;
								if (this.$refs.localView && this.$refs.localView.getNativeViewRef) {
									this.rtcEngine.setLocalView(this.$refs.localView
										.getNativeViewRef(), (code) => {
											console.log('è®¾ç½®æœ¬åœ°è§†å›¾ç»“æœ:', code);
											if (code === 0) {
												console.log('æœ¬åœ°è§†å›¾è®¾ç½®æˆåŠŸ');
											} else {
												console.error('æœ¬åœ°è§†å›¾è®¾ç½®å¤±è´¥:', code);
											}
										});
								} else {
									console.error('localView å¼•ç”¨ä¸å­˜åœ¨æˆ–æ–¹æ³•ä¸å¯ç”¨');
								}
							}, 100);
						}
						uni.showToast({
							title: 'åˆ‡æ¢èº«ä»½æˆåŠŸ',
							icon: 'none'
						})
					} else {
						// åˆ‡æ¢å¤±è´¥
						uni.showToast({
							title: 'åˆ‡æ¢èº«ä»½å¤±è´¥',
							icon: 'none'
						})
					}
				});
				// è°ƒç”¨åˆ‡æ¢è§’è‰²
				this.rtcEngine.switchLiveRole(userRole);
			},
			
			/**
			 * æ’­æ”¾æ··éŸ³    æ³¨æ„ï¼šæ”¯æŒ æ’­æ”¾çº¿ä¸ŠéŸ³é¢‘æ–‡ä»¶ï¼Œä¹Ÿæ”¯æŒæœ¬åœ°éŸ³é¢‘æ–‡ä»¶ï¼Œè¿™é‡Œä»¥çº¿ä¸ŠéŸ³é¢‘æ–‡ä»¶æ¼”ç¤º
			 */
			startAudioMixing(){
				console.log('startAudioMixing')
				this.statusText = 'æ’­æ”¾æ··éŸ³';
				let path = 'http://music.163.com/song/media/outer/url?id=1306417064.mp3';
				this.rtcEngine.startAudioMixing(path, RCRTCAudioMixingMode.Mixing, true, -1);
			},
			
			/**
			 * åœæ­¢æ’­æ”¾æ··éŸ³
			 */
			stopAudioMixing(){
				this.statusText = 'åœæ­¢æ’­æ”¾æ··éŸ³';
				console.log('stopAudioMixing')
				this.rtcEngine.stopAudioMixing();
			},
			

			/**
			 * æ‰“å¼€/å…³é—­æ‘„åƒå¤´    æ‘„åƒå¤´å…¶ä»–è®¾ç½®å‚è€ƒæ–‡æ¡£ï¼šhttps://docs.rongcloud.cn/uni-app-rtclib/device/camera
			 */
			enableCamera(enable) {
				console.log(enable ? 'æ‰“å¼€æ‘„åƒå¤´' : 'å…³é—­æ‘„åƒå¤´');
				this.rtcEngine.enableCamera(enable);
				this.isCameraOn = enable;
				console.log('isSpeakerOn')
				uni.showToast({
					title: enable ? 'æ‰“å¼€æ‘„åƒå¤´' : 'å…³é—­æ‘„åƒå¤´',
					icon: 'none'
				});
			},

			/**
			 * æ‰“å¼€/å…³é—­éº¦å…‹é£    éº¦å…‹é£å…¶ä»–æ“ä½œï¼šhttps://docs.rongcloud.cn/uni-app-rtclib/device/microphone
			 */
			enableMicrophone(enable) {
				console.log(enable ? 'æ‰“å¼€éº¦å…‹é£' : 'å…³é—­éº¦å…‹é£');
				this.isMicrophoneOn = enable;
				this.rtcEngine.enableMicrophone(enable);
				uni.showToast({
					title: enable ? 'å·²æ‰“å¼€éº¦å…‹é£' : 'å·²å…³é—­éº¦å…‹é£',
					icon: 'none'
				});
			},

			/**
			 * æ‰“å¼€/å…³é—­æ‰¬å£°å™¨     å‚è€ƒæ–‡æ¡£ï¼šhttps://docs.rongcloud.cn/uni-app-rtclib/device/speaker
			 */
			enableSpeaker(enable) {
				console.log(enable ? 'æ‰“å¼€æ‰¬å£°å™¨' : 'å…³é—­æ‰¬å£°å™¨');
				this.isSpeakerOn = true;
				this.rtcEngine.enableSpeaker(enable);
				console.log('isSpeakerOn')
				uni.showToast({
					title: enable ? 'å·²æ‰“å¼€æ‰¬å£°å™¨' : 'å·²å…³é—­æ‰¬å£°å™¨',
					icon: 'none'
				});
			},



			/**
			 * å¼ºåˆ¶æ¸…ç†æ‰€æœ‰èµ„æº
			 */
			forceCleanup() {
				console.log('å¼ºåˆ¶æ¸…ç†æ‰€æœ‰èµ„æºå¼€å§‹...');

				// è®¾ç½®é”€æ¯æ ‡å¿—
				this._isDestroyed = true;

				// æ¸…ç†ç›‘å¬å™¨å¼•ç”¨
				if (this.roomJoinedListener) {
					this.roomJoinedListener = null;
					console.log('ç›‘å¬å™¨å¼•ç”¨å·²æ¸…ç†');
				}

				// æ¸…ç†RTCå¼•æ“
				if (this.rtcEngine) {
					try {
						this.rtcEngine.setOnRoomJoinedListener(null);
						this.rtcEngine.setOnPublishedListener(null);
						this.rtcEngine.setOnUnpublishedListener(null);
						this.rtcEngine.setOnUserJoinedListener(null);
						this.rtcEngine.setOnRemotePublishedListener(null);
						this.rtcEngine.destroy();
						this.rtcEngine = null;
					} catch (e) {
						console.log('ç§»é™¤ç›‘å¬å™¨æ—¶å‡ºç°å¼‚å¸¸:', e);
						this.rtcEngine.destroy();
						this.rtcEngine = null;
					}
				}

				// é‡ç½®æ‰€æœ‰çŠ¶æ€
				try {
					this.isInRoom = false;
					this.isLocalVideoReady = false;
					this.isRemoteVideoReady = false;
					this.isMixRemoteVideoReady = false;
					this.isJoining = false;
					this.isAudienceJoining = false;
					this.isCameraOn = false;
					this.isMicrophoneOn = false;
					this.isSpeakerOn = false;
					this.statusText = 'å·²æ¸…ç†';
					this._isInitialized = false;
					this.remoteUserId = '';
					this.isRemoteStreams = false;
				} catch (e) {
					console.log('é‡ç½®çŠ¶æ€æ—¶å‡ºç°å¼‚å¸¸:', e);
				}

				console.log('å¼ºåˆ¶æ¸…ç†æ‰€æœ‰èµ„æºå®Œæˆ');
			},
		}
	}
</script>

<style scoped>
	.rtc-container {
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background-color: #f5f7fa;
		display: flex;
		flex-direction: column;
	}

	.status-bar-placeholder {
		height: 44px;
		background-color: #667eea;
	}

	.header {
		background-color: #667eea;
		box-shadow: 0 4rpx 12rpx rgba(102, 126, 234, 0.15);
	}

	.title-row {
		height: 88rpx;
		padding-left: 30rpx;
		padding-right: 30rpx;
		display: flex;
		flex-direction: row;
		align-items: center;
		position: relative;
	}

	.nav-left {
		display: flex;
		flex-direction: row;
		align-items: center;
		margin-right: 30rpx;
	}

	.nav-left-btn {
		background-color: transparent;
		border: none;
		padding: 0;
		margin: 0;
		display: flex;
		flex-direction: row;
		align-items: center;
		margin-right: 30rpx;
	}

	.back-button-container {
		position: absolute;
		top: 50%;
		left: 30rpx;
		transform: translateY(-10%);
		z-index: 1000;
	}

	.back-text {
		font-size: 28rpx;
		color: white;
	}

	.nav-title {
		position: absolute;
		left: 0;
		right: 0;
		font-size: 36rpx;
		font-weight: bold;
		color: white;
		text-align: center;
	}

	.room-info-text {
		font-size: 26rpx;
		color: rgba(255, 255, 255, 0.9);
		background-color: rgba(255, 255, 255, 0.1);
		padding: 8rpx 16rpx;
		border-radius: 20rpx;
	}

	.user-info-text {
		font-size: 26rpx;
		color: rgba(255, 255, 255, 0.9);
		background-color: rgba(255, 255, 255, 0.1);
		padding: 8rpx 16rpx;
		border-radius: 20rpx;
	}

	.video-container {
		padding: 32rpx;
		padding-bottom: 20rpx;
		display: flex;
		flex-direction: column;
	}

	.video-card {
		background-color: white;
		border-radius: 20rpx;
		padding: 20rpx;
		margin-bottom: 0;
		box-shadow: 0 4rpx 12rpx rgba(0, 0, 0, 0.08);
	}

	.video-card-header {
		display: flex;
		flex-direction: row;
		align-items: center;
		margin-bottom: 20rpx;
	}

	.card-title {
		font-size: 32rpx;
		color: #333;
		font-weight: bold;
		margin-left: 12rpx;
	}

	.video-row {
		display: flex;
		flex-direction: row;
	}

	.video-item {
		flex: 1;
		display: flex;
		flex-direction: column;
		margin: 0 10rpx;
	}

	.video-icon {
		font-size: 24rpx;
		margin-right: 12rpx;
	}

	.video-content {
		flex: 1;
	}

	.video-placeholder {
		height: 200rpx;
		background-color: #f8f9fa;
		border-radius: 12rpx;
		display: flex;
		align-items: center;
		justify-content: center;
		border: 1rpx solid #ddd;
	}

	.placeholder-text {
		color: #6c757d;
		font-size: 24rpx;
		text-align: center;
	}

	.video-player {
		flex: 1;
		height: 200rpx;
		border-radius: 12rpx;
		background-color: #000;
	}

	.control-panel {
		background-color: white;
		padding: 30rpx;
		margin: 20rpx 32rpx 32rpx 32rpx;
		border-radius: 25rpx;
		box-shadow: 0 8rpx 24rpx rgba(0, 0, 0, 0.1);
		border: 1rpx solid rgba(255, 255, 255, 0.8);
	}

	.room-info {
		flex-direction: row;
		align-items: center;
		margin-bottom: 30rpx;
		background-color: #f8f9fa;
		padding: 20rpx;
		border-radius: 15rpx;
		border: 1rpx solid #e9ecef;
	}

	.room-label {
		font-size: 28rpx;
		color: #495057;
		margin-right: 20rpx;
		width: 120rpx;
		font-weight: 500;
	}

	.room-input {
		flex: 1;
		height: 70rpx;
		border: 0;
		border-radius: 12rpx;
		padding: 0 20rpx;
		font-size: 28rpx;
		background-color: white;
		box-shadow: 0 2rpx 8rpx rgba(0, 0, 0, 0.05);
	}

	.button-row {
		display: flex;
		flex-direction: row;
		margin-bottom: 24rpx;
	}

	.control-btn {
		flex: 1;
		height: 88rpx;
		border-radius: 18rpx;
		border: 0;
		position: relative;
		overflow: hidden;
		margin: 0 8rpx;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.btn-text {
		font-size: 12dp;
		font-weight: bold;
		text-align: center;
		color: white;
	}

	.control-btn:first-child {
		margin-left: 0;
	}

	.control-btn:last-child {
		margin-right: 0;
	}

	.join-btn {
		background-color: #669eea;
		color: white;
		box-shadow: 0 4rpx 12rpx rgba(102, 126, 234, 0.3);
	}

	.join-btn.disabled {
		background-color: #ccc;
		box-shadow: none;
	}

	.join-btn.disabled .btn-text {
		color: #666;
	}

	.leave-btn {
		background-color: #ff6b6b;
		color: white;
		box-shadow: 0 4rpx 12rpx rgba(255, 107, 107, 0.3);
	}

	.leave-btn.disabled {
		background-color: #ccc;
		box-shadow: none;
	}

	.leave-btn.disabled .btn-text {
		color: #666;
	}

	.rtc-btn {
		background-color: #669eea;
		color: white;
		box-shadow: 0 4rpx 12rpx rgba(40, 167, 69, 0.3);
	}

	.debug-btn {
		background-color: #6c757d;
		color: white;
		box-shadow: 0 4rpx 12rpx rgba(108, 117, 125, 0.3);
	}

	.debug-btn:active {
		background-color: #003a6c;
		box-shadow: 0 4rpx 12rpx rgba(73, 80, 87, 0.4);
	}

	.status-bar {
		background-color: #343a40;
		padding: 24rpx 40rpx;
		margin: 20rpx 32rpx 0 32rpx;
		border-radius: 15rpx;
		box-shadow: 0 4rpx 12rpx rgba(0, 0, 0, 0.15);
		position: relative;
		overflow: hidden;
	}

	.status-text {
		color: white;
		font-size: 26rpx;
		text-align: center;
		font-weight: 500;
	}
</style>